#! https://zhuanlan.zhihu.com/p/581487761
# 备份与恢复

## 备份/恢复策略
进行备份和恢复时要考虑的因素
- 确定要备份的表存储引擎是事务型还是非事务型，两种存储引擎对数据一致性的处理不一样。
- 确定使用全备份还是增量备份。全备份的优点是备份保持最新备份，恢复时花费时间少；缺点是如果数据量大，花费时间多，对系统造成较长时间的压力。增量备份相反，只需要备份每天的增量日志，时间少、压力小；缺点是恢复的时候需要全备份加上次备份到故障前的所有日志，恢复时间长。
- 可以考虑采用复制的方法做异地备份，但是复制不能代替备份，对数据库的误操作也无能为力。
- 要定期备份，备份的周期要充分考虑系统可以承受的恢复的时间。备份要在系统负荷较小的时候进行。
- 确保MySQL打开log-bin选项，有了binlog MySQL才能在必要的时候做完整恢复、基于时间点的恢复、基于位置的恢复。
- 要经常做备份恢复测试，确保备份是有效的，是可以恢复的。
## 逻辑备份和恢复
逻辑备份的优点是对于不同的存储引擎备份方法是一样的。物理备份不同。对于混合存储引擎的数据库，用逻辑备份更简单。
### 备份
将数据备份成一个文本文件，可以查看和编辑。可以使用mysqldump工具完成。
- 备份某些表
```
mysqldump [options] db_name [tables]
```
- 备份一个或多个数据库
```
mysqldump [options] ---database DB1 [DB2 DB3...]
```
- 备份所有数据库
```
mysqldump [options] --all-database
```
- All
```
[root@localhost ~]# mysqldump -uroot -p --all-database > all.sql
Warning: Using unique option prefix all-database instead of all-databases is deprecated and will be removed in a future release. Please use the full name instead.
Enter password: 

[root@localhost ~]# head -n 10 all.sql 
-- MySQL dump 10.13  Distrib 5.6.33-79.0, for Linux (x86_64)
--
-- Host: localhost    Database: 
-- ------------------------------------------------------
-- Server version	5.6.33-79.0-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;

```
- 某库
```
[root@localhost ~]# mysqldump -uroot -p sakila > sakila.sql
Enter password: 
[root@localhost ~]# ls
anaconda-ks.cfg  explain  sakila.sql
[root@localhost ~]# head -n 10 sakila.sql 
-- MySQL dump 10.13  Distrib 5.6.33-79.0, for Linux (x86_64)
--
-- Host: localhost    Database: sakila
-- ------------------------------------------------------
-- Server version	5.6.33-79.0-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
```
- 某库某表
```
[root@localhost ~]# mysqldump -uroot -p sakila  film > sakila.sql
Enter password: 
[root@localhost ~]# ls
anaconda-ks.cfg  explain  sakila.sql
[root@localhost ~]# head -n 10 sakila.sql 
-- MySQL dump 10.13  Distrib 5.6.33-79.0, for Linux (x86_64)
--
-- Host: localhost    Database: sakila
-- ------------------------------------------------------
-- Server version	5.6.33-79.0-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
```
- 某库某些表
```
[root@localhost ~]# mysqldump -uroot -p sakila  film actor > sakila.sql
Enter password: 
[root@localhost ~]# ls
anaconda-ks.cfg  explain  sakila.sql
[root@localhost ~]# head -n 10 sakila.sql 
-- MySQL dump 10.13  Distrib 5.6.33-79.0, for Linux (x86_64)
--
-- Host: localhost    Database: sakila
-- ------------------------------------------------------
-- Server version	5.6.33-79.0-log

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;

```
- 备份数据库下的所有表为逗号分隔的文本。复制到/tmp中。
```
[root@localhost /]# mysqldump -uroot -T /tmp sakila -p --fields-terminated-by ','
Enter password: 

[root@localhost tmp]# more actor.txt 
1,PENELOPE,GUINESS,2006-02-14 20:34:33
2,NICK,WAHLBERG,2006-02-14 20:34:33
3,ED,CHASE,2006-02-14 20:34:33
4,JENNIFER,DAVIS,2006-02-14 20:34:33
5,JOHNNY,LOLLOBRIGIDA,2006-02-14 20:34:33
```
### 完全恢复
一个备份恢复的过程
1. 备份。-l是给所有表加读锁，-F是生成一个新的日志文件。
```
[root@localhost /]# mysqldump -uroot -p -l -F sakila > sakila_0.dmp
Enter password: 
```
2. 备份完成后插入一条数据
```
mysql> insert into actor(actor_id,first_name,last_name) values(3333,'zuo','dongyue');
Query OK, 1 row affected (0.00 sec)
mysql> insert into actor(actor_id,first_name,last_name) values(3332,'zuo2','dongyue2');
Query OK, 1 row affected (0.00 sec)
```
3. 数据库需要恢复备份了
```
[root@localhost /]# mysql -u root -p sakila < sakila_0.dmp
Enter password: 
mysql> select * from actor where actor_id=3333 or actor_id=3332;
Empty set (0.00 sec)
```
4. 使用mysqlbinlog恢复自MySQLdump备份以来的BINLOG。
```
配置文件添加，打开log-bin。
server-id=1148
log-bin=/var/lib/mysql/mysql-bin

mysql> show variables like '%log_bin%';
+---------------------------------+--------------------------------+
| Variable_name                   | Value                          |
+---------------------------------+--------------------------------+
| log_bin                         | ON                             |
| log_bin_basename                | /var/lib/mysql/mysql-bin       |
| log_bin_index                   | /var/lib/mysql/mysql-bin.index |
| log_bin_trust_function_creators | OFF                            |
| log_bin_use_v1_row_events       | OFF                            |
| sql_log_bin                     | ON                             |
+---------------------------------+--------------------------------+
```
使用binlog恢复，遇到了错误`unknown variable 'default_character_set=utf8'`。有两种解决方法：
1. 将配置文件中的参数`default_character_set=utf8`改为`character_set_server=utf8`。要重启mysql服务，代价大
2. 加上参数`--no-defaults`
```
[root@localhost mysql]# mysqlbinlog --no-default mysql-bin.000001 | mysql -uroot -p sakila
Enter password: mysqlbinlog: unknown variable 'default_character_set=utf8'

[root@localhost mysql]# mysqlbinlog --no-defaults mysql-bin.000001 | mysql -uroot -p sakila
Enter password: 
```
恢复结果
```

```